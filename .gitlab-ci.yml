image: python:3.6

stages:
  - initdb
  - build
  - test

variables:
  DB_PASSWORD: dbcuttest
  DB_NAME: dbcuttest
  DB_USER: dbcuttest
  POSTGRES_DB: $DB_NAME
  POSTGRES_USER: $DB_USER
  POSTGRES_PASSWORD: $DB_PASSWORD
  MYSQL_DATABASE: $DB_NAME
  MYSQL_ROOT_PASSWORD: $DB_PASSWORD


services:
- name: mariadb:latest
  alias: mariadb-1
- name: mariadb:latest
  alias: mariadb-2
- name: postgres:latest
  alias: postgres

initdb:
  stage: initdb
  image: mariadb:latest
  script:
  - echo "SELECT 'OK';" | mysql --user=root --password="$MYSQL_ROOT_PASSWORD" --host=mariadb-1 "$MYSQL_DATABASE"


build:
  stage: build
  script:
    - bash docker/build-base.sh
    - make init

test:
  stage: test
  script:
    - make test

